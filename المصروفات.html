<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª 2025</title>

  <!-- Cairo font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap (RTL) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --brand:#1e3c72;
      --cardShadow: 0 4px 10px rgba(0,0,0,.08);
    }
    body, .btn, .form-control, .form-select, .table { font-family: "Cairo", sans-serif; }
    .app { min-height: 100vh; }
    .sidebar {
      background: #0f1f3a;
      color: #fff;
      min-height: 100vh;
      position: sticky;
      top: 0;
      padding: 18px 14px;
    }
    .sidebar h5 { color: #fff; margin-bottom: 14px; }
    .navbtn {
      width:100%;
      text-align:right;
      margin-bottom:8px;
      border-radius:10px;
      background: rgba(255,255,255,.08);
      color:#fff;
      border: 1px solid rgba(255,255,255,.10);
      padding:10px 12px;
    }
    .navbtn.active { background: rgba(255,255,255,.18); border-color: rgba(255,255,255,.22); }
    .content { padding: 22px 18px; }
    .cardx {
      background:#fff;
      border-radius:14px;
      box-shadow: var(--cardShadow);
      padding: 14px 16px;
    }
    .metric .label { color:#556; font-size: 13px; }
    .metric .value { font-size: 22px; font-weight: 800; color: var(--brand); }
    .muted { color:#667; }
    .smallmuted { color:#778; font-size: 12px; }
    .section-title { color: var(--brand); font-weight: 800; }
    .plotbox { background:#fff; border-radius:14px; box-shadow: var(--cardShadow); padding: 10px; }
    .table thead th { white-space: nowrap; }
    .badge-soft { background:#eef2ff; color:#273; border:1px solid #dfe6ff; }
    .danger-soft { background:#fff1f1; border:1px solid #ffd6d6; }
  </style>
</head>

<body>
<div class="container-fluid app">
  <div class="row g-0">
    <!-- Sidebar -->
    <aside class="col-12 col-lg-3 col-xl-2 sidebar">
      <h5 class="mb-2">âš™ï¸ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h5>

      <div class="cardx mb-3" style="background: rgba(255,255,255,.06); color:#fff; box-shadow:none;">
        <div class="mb-2 fw-bold">ğŸ“ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
        <input id="fileInput" class="form-control form-control-sm" type="file" accept=".xlsx,.xls" multiple />
        <div class="smallmuted mt-2" style="color: rgba(255,255,255,.78)">
          Ø§Ø±ÙØ¹ Ù…Ù„Ù/Ù…Ù„ÙØ§Øª Excel ØªØ­ØªÙˆÙŠ Ø´ÙŠØª <b>Ø¨ÙŠØ§Ù†Ø§Øª</b>. Ø³ÙŠØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
        </div>
        <div id="uploadStatus" class="smallmuted mt-2" style="color: rgba(255,255,255,.85)"></div>
      </div>

      <div class="mb-3">
        <button class="navbtn active" data-page="dashboard">ğŸ“ˆ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
        <button class="navbtn" data-page="data">ğŸ“‹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        <button class="navbtn" data-page="add">â• Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
        <button class="navbtn" data-page="history">ğŸ“œ Ø§Ù„Ø³Ø¬Ù„</button>
        <button class="navbtn" data-page="export">ğŸ’¾ Ø§Ù„ØªØµØ¯ÙŠØ±</button>
        <button class="navbtn" data-page="files">ğŸ“‚ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª</button>
      </div>

      <div class="cardx" style="background: rgba(255,255,255,.06); color:#fff; box-shadow:none;">
        <div class="smallmuted" style="color: rgba(255,255,255,.80)">
          ğŸ’¡ ØªØ·ÙˆÙŠØ±: Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø§Ù„ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„<br>
          ğŸ“… Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="lastUpdate"></span><br><br>
          ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©: <span id="origCount">0</span><br>
          â• Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©: <span id="manualCount">0</span>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="col-12 col-lg-9 col-xl-10 content">
      <div class="mb-3">
        <h2 class="section-title mb-1">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª 2025</h2>
        <div class="muted">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© ÙˆØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ù†Ø³Ø®Ø© HTML/JS Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ±ÙØ±)</div>
      </div>

      <!-- Pages -->
      <section id="page-dashboard" class="page">
        <div id="noDataHint" class="alert alert-info" style="display:none;">
          ğŸ‘† Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù Excel Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ø¨Ø¯Ø¡
        </div>

        <div class="row g-3 mb-3" id="metricsRow" style="display:none;">
          <div class="col-12 col-md-6 col-xl-3">
            <div class="cardx metric">
              <div class="label">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
              <div class="value" id="mRevenue">0</div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-xl-3">
            <div class="cardx metric">
              <div class="label">ğŸ’¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
              <div class="value" id="mExpense">0</div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-xl-3">
            <div class="cardx metric">
              <div class="label">ğŸ“Š ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div>
              <div class="value" id="mNet">0</div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-xl-3">
            <div class="cardx metric">
              <div class="label">ğŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</div>
              <div class="value" id="mCount">0</div>
            </div>
          </div>
        </div>

        <div id="chartsArea" style="display:none;">
          <div class="plotbox mb-3">
            <h5 class="section-title mb-2">ğŸ“Š Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h5>
            <div id="chartMonthlyBars"></div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-12 col-xl-6">
              <div class="plotbox">
                <h5 class="section-title mb-2">ğŸ¥§ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨</h5>
                <div id="chartExpensePie"></div>
              </div>
            </div>
            <div class="col-12 col-xl-6">
              <div class="plotbox">
                <h5 class="section-title mb-2">ğŸ¥§ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø³Ø§Ø¨</h5>
                <div id="chartRevenuePie"></div>
              </div>
            </div>
          </div>

          <div class="plotbox">
            <h5 class="section-title mb-2">ğŸ“ˆ ØªØ·ÙˆØ± ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h5>
            <div id="chartNetLine"></div>
          </div>
        </div>
      </section>

      <section id="page-data" class="page" style="display:none;">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h4 class="section-title m-0">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</h4>
          <div class="smallmuted">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: <span id="shownCount">0</span></div>
        </div>

        <div class="row g-2 mb-3">
          <div class="col-12 col-md-4">
            <label class="form-label">Ø§Ù„Ø´Ù‡Ø±</label>
            <select id="filterMonth" class="form-select"></select>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <select id="filterAccount" class="form-select"></select>
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
            <select id="filterType" class="form-select">
              <option value="all">Ø§Ù„ÙƒÙ„</option>
              <option value="rev">Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</option>
              <option value="exp">Ù…ØµØ±ÙˆÙØ§Øª</option>
            </select>
          </div>
        </div>

        <div class="cardx">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ø´Ù‡Ø±</th>
                  <th>Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„ÙˆØµÙ</th>
                  <th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th>
                  <th>Ø§Ù„Ù…ØµØ±ÙˆÙ</th>
                  <th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</th>
                  <th>Ø§Ù„Ù…Ø¶ÙŠÙ</th>
                  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                </tr>
              </thead>
              <tbody id="dataTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="page-add" class="page" style="display:none;">
        <h4 class="section-title mb-3">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ù…Ø§Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h4>

        <div class="cardx">
          <form id="addForm" class="row g-3">
            <div class="col-12 col-lg-6">
              <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ù† ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ©) *</label>
              <input id="fAddedBy" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" required />
            </div>

            <div class="col-12 col-lg-6">
              <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ù…Ù„ÙŠØ© *</label>
              <input id="fDate" type="date" class="form-control" required />
            </div>

            <div class="col-12 col-lg-6">
              <label class="form-label">Ø§Ù„Ø´Ù‡Ø± *</label>
              <select id="fMonth" class="form-select" required></select>
            </div>

            <div class="col-12 col-lg-6">
              <label class="form-label">Ø§Ù„Ø­Ø³Ø§Ø¨ *</label>
              <input id="fAccount" class="form-control" placeholder="Ù…Ø«Ø§Ù„: Ø¥ÙŠØ¬Ø§Ø± / Ø±ÙˆØ§ØªØ¨ / Ù…Ø¨ÙŠØ¹Ø§Øª..." required />
              <div class="smallmuted mt-1">ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØªØ§Ø¨Ø© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
            </div>

            <div class="col-12 col-lg-6">
              <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹ *</label>
              <select id="fPayType" class="form-select" required>
                <option value="">Ø§Ø®ØªØ±</option>
                <option>Ù†Ù‚Ø¯ÙŠ</option>
                <option>Ù†Ù‚Ø¯Ø§</option>
                <option>Ø¨Ù†ÙƒÙŠ</option>
                <option>Ø´ÙŠÙƒ</option>
                <option>ØªØ­ÙˆÙŠÙ„</option>
              </select>
            </div>

            <div class="col-12 col-lg-6">
              <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº *</label>
              <input id="fAmount" type="number" min="0" step="0.01" class="form-control" required />
            </div>

            <div class="col-12">
              <label class="form-label">ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© *</label>
              <textarea id="fDesc" class="form-control" rows="3" placeholder="Ø£Ø¯Ø®Ù„ ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø¹Ù…Ù„ÙŠØ©" required></textarea>
            </div>

            <div class="col-12 col-lg-6">
              <label class="form-label">Ø§Ù„Ù…Ø±Ø¬Ø¹</label>
              <input id="fRef" class="form-control" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø£Ùˆ Ø§Ù„ÙØ§ØªÙˆØ±Ø©" />
            </div>

            <div class="col-12 col-lg-6">
              <label class="form-label d-block">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© *</label>
              <div class="d-flex gap-3 mt-2">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="fTxType" id="txRev" value="rev" checked>
                  <label class="form-check-label" for="txRev">Ø¥ÙŠØ±Ø§Ø¯</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="fTxType" id="txExp" value="exp">
                  <label class="form-check-label" for="txExp">Ù…ØµØ±ÙˆÙ</label>
                </div>
              </div>
            </div>

            <div class="col-12">
              <button class="btn btn-primary w-100" type="submit">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
              <div id="addMsg" class="mt-2"></div>
            </div>
          </form>
        </div>
      </section>

      <section id="page-history" class="page" style="display:none;">
        <h4 class="section-title mb-3">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ§Øª</h4>
        <div id="historyList"></div>
      </section>

      <section id="page-export" class="page" style="display:none;">
        <h4 class="section-title mb-3">ğŸ’¾ ØªØµØ¯ÙŠØ± ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h4>

        <div class="row g-3 mb-3">
          <div class="col-12 col-xl-6">
            <div class="cardx">
              <h6 class="section-title mb-2">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</h6>
              <button id="btnExportExcel" class="btn btn-outline-primary w-100">ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel</button>
              <div class="smallmuted mt-2">ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.</div>
            </div>
          </div>
          <div class="col-12 col-xl-6">
            <div class="cardx">
              <h6 class="section-title mb-2">ğŸ“„ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ JSON</h6>
              <button id="btnExportJson" class="btn btn-outline-primary w-100">ğŸ“„ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù JSON</button>
              <div class="smallmuted mt-2">Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ/Ø§Ù„Ù†Ù‚Ù„.</div>
            </div>
          </div>
        </div>

        <div class="cardx danger-soft">
          <h6 class="section-title mb-2">ğŸ—‘ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h6>
          <div class="alert alert-warning mb-3">âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§!</div>
          <div class="row g-2">
            <div class="col-12 col-xl-6">
              <button id="btnDeleteManual" class="btn btn-outline-danger w-100">ğŸ”„ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙ‚Ø·</button>
            </div>
            <div class="col-12 col-xl-6">
              <button id="btnDeleteAll" class="btn btn-danger w-100">âš ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>
          </div>
          <div id="exportMsg" class="mt-2"></div>
        </div>
      </section>

      <section id="page-files" class="page" style="display:none;">
        <h4 class="section-title mb-3">ğŸ“‚ Ø¥Ø¯Ø§Ø±Ø© Ù…Ù„ÙØ§Øª Excel Ø§Ù„Ù…Ø­Ù…Ù„Ø©</h4>

        <div id="filesEmpty" class="alert alert-info" style="display:none;">
          ğŸ“­ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ Ù…Ù„ÙØ§Øª Ø¨Ø¹Ø¯. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Excel.
        </div>

        <div id="filesPanel" style="display:none;">
          <div class="d-flex gap-3 flex-wrap mb-3">
            <span class="badge badge-soft">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù„ÙØ§Øª: <span id="filesCount">0</span></span>
            <span class="badge badge-soft">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: <span id="rowsCount">0</span></span>
          </div>

          <div class="cardx mb-3">
            <h6 class="section-title mb-2">ğŸ“Š Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª</h6>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù</th>
                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ­Ù…ÙŠÙ„</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="filesTbody"></tbody>
              </table>
            </div>
          </div>

          <div class="cardx mb-3">
            <h6 class="section-title mb-2">âš™ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ù…ØªÙ‚Ø¯Ù…Ø©</h6>
            <div class="row g-2">
              <div class="col-12 col-xl-4">
                <button id="btnResetFiles" class="btn btn-outline-secondary w-100">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ (Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)</button>
              </div>
              <div class="col-12 col-xl-4">
                <button id="btnClearHistory" class="btn btn-outline-secondary w-100">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
              </div>
              <div class="col-12 col-xl-4">
                <button id="btnQuickStats" class="btn btn-outline-secondary w-100">ğŸ“Œ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</button>
              </div>
            </div>
            <div id="filesMsg" class="mt-2"></div>
          </div>

          <div class="cardx">
            <h6 class="section-title mb-2">ğŸ” ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª</h6>
            <div id="dupMsg" class="mb-2 smallmuted"></div>
            <div class="d-flex gap-2 flex-wrap mb-2">
              <button id="btnShowDups" class="btn btn-outline-primary btn-sm">Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©</button>
              <button id="btnRemoveDups" class="btn btn-outline-danger btn-sm">Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</button>
            </div>
            <div class="table-responsive" id="dupsTableWrap" style="display:none;">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø´Ù‡Ø±</th><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ù…ØµØ±ÙˆÙ</th><th>Ø§ÙŠØ±Ø§Ø¯</th><th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                  </tr>
                </thead>
                <tbody id="dupsTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <footer class="smallmuted mt-4">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ù†Ø³Ø®Ø© HTML/JS Ù„Ù„ØªØ´ØºÙŠÙ„ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­. Ø¥Ø°Ø§ ØªØ±ÙŠØ¯ Ù†ÙØ³ Ø³Ù„ÙˆÙƒ Streamlit Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø¬Ù„Ø³Ø§Øª + Ù…Ù„ÙØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± + ØµÙ„Ø§Ø­ÙŠØ§Øª)ØŒ ØªØ­ØªØ§Ø¬ Backend (Ù…Ø«Ù„ Python/FastAPI Ø£Ùˆ Ù†ÙØ³ Streamlit).
      </footer>
    </main>
  </div>
</div>

<script>
/* =========================
   Storage & State
========================= */
const KEYS = {
  DATA: "fin_data_rows_v1",
  FILES: "fin_loaded_files_v1",
  HISTORY: "fin_history_v1"
};

const AR_MONTHS = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø§Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];

let state = {
  rows: [],
  loadedFiles: [],
  history: []
};

function loadState(){
  try {
    state.rows = JSON.parse(localStorage.getItem(KEYS.DATA) || "[]");
    state.loadedFiles = JSON.parse(localStorage.getItem(KEYS.FILES) || "[]");
    state.history = JSON.parse(localStorage.getItem(KEYS.HISTORY) || "[]");
  } catch(e){
    state = { rows:[], loadedFiles:[], history:[] };
  }
}
function saveState(){
  localStorage.setItem(KEYS.DATA, JSON.stringify(state.rows));
  localStorage.setItem(KEYS.FILES, JSON.stringify(state.loadedFiles));
  localStorage.setItem(KEYS.HISTORY, JSON.stringify(state.history));
}
function addHistory(action, details){
  const item = { timestamp: new Date().toISOString(), action, details };
  state.history.unshift(item);
  state.history = state.history.slice(0, 100);
  saveState();
}

/* =========================
   Helpers
========================= */
function fmtMoney(x){
  const n = Number(x || 0);
  return n.toLocaleString("ar-SA", {minimumFractionDigits:2, maximumFractionDigits:2}) + " Ø±ÙŠØ§Ù„";
}
function fmtNum(x){
  const n = Number(x || 0);
  return n.toLocaleString("ar-SA", {minimumFractionDigits:2, maximumFractionDigits:2});
}
function fmtDate(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(isNaN(d)) return "";
  return d.toISOString().slice(0,10);
}
function deriveMonthFromDate(iso){
  const d = new Date(iso);
  if(isNaN(d)) return "";
  return AR_MONTHS[d.getMonth()];
}
function nowText(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const hh = String(d.getHours()).padStart(2,"0");
  const mi = String(d.getMinutes()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
}
function uniq(arr){
  return [...new Set(arr)];
}
function safeText(v){
  if(v === null || v === undefined) return "";
  return String(v).trim();
}

/* =========================
   Excel parsing (SheetJS)
========================= */
function findHeaderRowIndex(aoa){
  // Find row that contains "Ø§Ù„ØªØ§Ø±ÙŠØ®"
  for(let i=0;i<aoa.length;i++){
    const row = aoa[i] || [];
    const hit = row.some(cell => String(cell || "").includes("Ø§Ù„ØªØ§Ø±ÙŠØ®"));
    if(hit) return i;
  }
  return -1;
}
function aoaToObjects(aoa, headerIdx){
  const headerRow = (aoa[headerIdx] || []).map(h => safeText(h));
  const mapIdx = {};
  headerRow.forEach((h, idx) => { if(h) mapIdx[h] = idx; });

  // expected columns (Arabic names from your code)
  const colDate = "Ø§Ù„ØªØ§Ø±ÙŠØ®";
  const colMonth = "Ø§Ù„Ø´Ù‡Ø±";
  const colAccount = "Ø§Ù„Ø­Ø³Ø§Ø¨";
  const colType = "Ø§Ù„Ù†ÙˆØ¹";
  const colDesc = "ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©";
  const colRef = "Ø§Ù„Ù…Ø±Ø¬Ø¹";
  const colExp = "Ù…ØµØ±ÙˆÙ";
  const colRev = "Ø§ÙŠØ±Ø§Ø¯";

  const out = [];
  for(let r=headerIdx+1; r<aoa.length; r++){
    const row = aoa[r];
    if(!row || row.every(c => safeText(c)==="")) continue;

    const rawDate = row[mapIdx[colDate]];
    let isoDate = "";
    // SheetJS may give Date object or number or string
    if(rawDate instanceof Date && !isNaN(rawDate)) isoDate = rawDate.toISOString();
    else if(typeof rawDate === "number"){
      const d = XLSX.SSF.parse_date_code(rawDate);
      if(d){
        const dd = new Date(Date.UTC(d.y, d.m-1, d.d));
        isoDate = dd.toISOString();
      }
    } else {
      const s = safeText(rawDate);
      if(s){
        const d = new Date(s);
        if(!isNaN(d)) isoDate = d.toISOString();
      }
    }
    if(!isoDate) continue;

    const obj = {
      "Ø§Ù„ØªØ§Ø±ÙŠØ®": isoDate,
      "Ø§Ù„Ø´Ù‡Ø±": safeText(row[mapIdx[colMonth]]) || deriveMonthFromDate(isoDate),
      "Ø§Ù„Ø­Ø³Ø§Ø¨": safeText(row[mapIdx[colAccount]]),
      "Ø§Ù„Ù†ÙˆØ¹": safeText(row[mapIdx[colType]]),
      "ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©": safeText(row[mapIdx[colDesc]]),
      "Ø§Ù„Ù…Ø±Ø¬Ø¹": safeText(row[mapIdx[colRef]]),
      "Ù…ØµØ±ÙˆÙ": Number(row[mapIdx[colExp]] || 0) || 0,
      "Ø§ÙŠØ±Ø§Ø¯": Number(row[mapIdx[colRev]] || 0) || 0,
      "addedBy": "",
      "addedTimestamp": "",
      "addedManually": false,
      "sourceFile": ""
    };
    out.push(obj);
  }
  return out;
}

async function parseExcelFile(file){
  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf, { type: "array" });
  const sheetName = wb.SheetNames.includes("Ø¨ÙŠØ§Ù†Ø§Øª") ? "Ø¨ÙŠØ§Ù†Ø§Øª" : wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];
  const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

  const headerIdx = findHeaderRowIndex(aoa);
  if(headerIdx < 0) throw new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (ØµÙ ÙŠØ­ØªÙˆÙŠ 'Ø§Ù„ØªØ§Ø±ÙŠØ®').");

  const rows = aoaToObjects(aoa, headerIdx);
  return rows;
}

/* =========================
   Calculations
========================= */
function calcStats(rows){
  const totalRev = rows.reduce((s,r)=>s + Number(r["Ø§ÙŠØ±Ø§Ø¯"]||0), 0);
  const totalExp = rows.reduce((s,r)=>s + Number(r["Ù…ØµØ±ÙˆÙ"]||0), 0);
  const net = totalRev - totalExp;
  return { totalRev, totalExp, net, count: rows.length };
}
function monthOrderKey(m){
  const i = AR_MONTHS.indexOf(m);
  return i < 0 ? 999 : i;
}
function groupMonthly(rows){
  const map = new Map();
  for(const r of rows){
    const m = r["Ø§Ù„Ø´Ù‡Ø±"] || deriveMonthFromDate(r["Ø§Ù„ØªØ§Ø±ÙŠØ®"]);
    if(!map.has(m)) map.set(m, { month:m, rev:0, exp:0 });
    const it = map.get(m);
    it.rev += Number(r["Ø§ÙŠØ±Ø§Ø¯"]||0);
    it.exp += Number(r["Ù…ØµØ±ÙˆÙ"]||0);
  }
  const out = [...map.values()].sort((a,b)=>monthOrderKey(a.month)-monthOrderKey(b.month));
  out.forEach(x => x.net = x.rev - x.exp);
  return out;
}
function topByAccount(rows, field){
  const map = new Map();
  for(const r of rows){
    const acc = r["Ø§Ù„Ø­Ø³Ø§Ø¨"] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    const v = Number(r[field]||0);
    if(v<=0) continue;
    map.set(acc, (map.get(acc)||0)+v);
  }
  const arr = [...map.entries()].map(([k,v])=>({name:k, value:v}));
  arr.sort((a,b)=>b.value-a.value);
  return arr.slice(0,10);
}

/* =========================
   Rendering
========================= */
function renderCounts(){
  const manual = state.rows.filter(r=>r.addedManually === true).length;
  const orig = state.rows.length - manual;
  document.getElementById("manualCount").textContent = manual;
  document.getElementById("origCount").textContent = orig;
  document.getElementById("lastUpdate").textContent = nowText();
}
function renderDashboard(){
  const hasData = state.rows.length > 0;
  document.getElementById("noDataHint").style.display = hasData ? "none" : "block";
  document.getElementById("metricsRow").style.display = hasData ? "flex" : "none";
  document.getElementById("chartsArea").style.display = hasData ? "block" : "none";
  if(!hasData) return;

  const s = calcStats(state.rows);
  document.getElementById("mRevenue").textContent = fmtMoney(s.totalRev);
  document.getElementById("mExpense").textContent = fmtMoney(s.totalExp);
  document.getElementById("mNet").textContent = fmtMoney(s.net);
  document.getElementById("mCount").textContent = s.count.toLocaleString("ar-SA");

  const monthly = groupMonthly(state.rows);
  const months = monthly.map(x=>x.month);
  const revs = monthly.map(x=>x.rev);
  const exps = monthly.map(x=>x.exp);
  const nets = monthly.map(x=>x.net);

  Plotly.newPlot("chartMonthlyBars", [
    { type:"bar", x: months, y: revs, name:"Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª" },
    { type:"bar", x: months, y: exps, name:"Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª" }
  ], {
    barmode:"group",
    height: 420,
    margin:{t:10,l:40,r:10,b:50},
    xaxis:{title:"Ø§Ù„Ø´Ù‡Ø±"},
    yaxis:{title:"Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„)"},
    hovermode:"x unified"
  }, {responsive:true});

  const expTop = topByAccount(state.rows, "Ù…ØµØ±ÙˆÙ");
  if(expTop.length){
    Plotly.newPlot("chartExpensePie", [{
      type:"pie",
      labels: expTop.map(x=>x.name),
      values: expTop.map(x=>x.value),
      hole: 0.4,
      textinfo:"percent+label"
    }], {height: 420, margin:{t:10,l:10,r:10,b:10}}, {responsive:true});
  } else {
    document.getElementById("chartExpensePie").innerHTML = "<div class='alert alert-info m-2'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµØ±ÙˆÙØ§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</div>";
  }

  const revTop = topByAccount(state.rows, "Ø§ÙŠØ±Ø§Ø¯");
  if(revTop.length){
    Plotly.newPlot("chartRevenuePie", [{
      type:"pie",
      labels: revTop.map(x=>x.name),
      values: revTop.map(x=>x.value),
      hole: 0.4,
      textinfo:"percent+label"
    }], {height: 420, margin:{t:10,l:10,r:10,b:10}}, {responsive:true});
  } else {
    document.getElementById("chartRevenuePie").innerHTML = "<div class='alert alert-info m-2'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</div>";
  }

  Plotly.newPlot("chartNetLine", [{
    type:"scatter",
    mode:"lines+markers",
    x: months,
    y: nets,
    name:"ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­"
  }], {
    height: 420,
    margin:{t:10,l:40,r:10,b:50},
    xaxis:{title:"Ø§Ù„Ø´Ù‡Ø±"},
    yaxis:{title:"ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (Ø±ÙŠØ§Ù„)"}
  }, {responsive:true});
}

function fillFilters(){
  const monthSel = document.getElementById("filterMonth");
  const accSel = document.getElementById("filterAccount");

  const months = uniq(state.rows.map(r=>r["Ø§Ù„Ø´Ù‡Ø±"]).filter(Boolean)).sort((a,b)=>monthOrderKey(a)-monthOrderKey(b));
  const accs = uniq(state.rows.map(r=>r["Ø§Ù„Ø­Ø³Ø§Ø¨"]).filter(Boolean)).sort();

  monthSel.innerHTML = `<option value="all">Ø§Ù„ÙƒÙ„</option>` + months.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join("");
  accSel.innerHTML = `<option value="all">Ø§Ù„ÙƒÙ„</option>` + accs.map(a=>`<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join("");
}

function renderTable(){
  const m = document.getElementById("filterMonth").value;
  const a = document.getElementById("filterAccount").value;
  const t = document.getElementById("filterType").value;

  let rows = [...state.rows];

  if(m !== "all") rows = rows.filter(r=>r["Ø§Ù„Ø´Ù‡Ø±"] === m);
  if(a !== "all") rows = rows.filter(r=>r["Ø§Ù„Ø­Ø³Ø§Ø¨"] === a);
  if(t === "rev") rows = rows.filter(r=>Number(r["Ø§ÙŠØ±Ø§Ø¯"]||0) > 0);
  if(t === "exp") rows = rows.filter(r=>Number(r["Ù…ØµØ±ÙˆÙ"]||0) > 0);

  document.getElementById("shownCount").textContent = rows.length.toLocaleString("ar-SA");

  // Sort by date desc
  rows.sort((x,y)=> new Date(y["Ø§Ù„ØªØ§Ø±ÙŠØ®"]) - new Date(x["Ø§Ù„ØªØ§Ø±ÙŠØ®"]));

  const tbody = document.getElementById("dataTbody");
  tbody.innerHTML = rows.map(r => `
    <tr>
      <td>${escapeHtml(fmtDate(r["Ø§Ù„ØªØ§Ø±ÙŠØ®"]))}</td>
      <td>${escapeHtml(r["Ø§Ù„Ø´Ù‡Ø±"]||"")}</td>
      <td>${escapeHtml(r["Ø§Ù„Ø­Ø³Ø§Ø¨"]||"")}</td>
      <td>${escapeHtml(r["Ø§Ù„Ù†ÙˆØ¹"]||"")}</td>
      <td style="min-width:220px">${escapeHtml(r["ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"]||"")}</td>
      <td>${escapeHtml(r["Ø§Ù„Ù…Ø±Ø¬Ø¹"]||"")}</td>
      <td>${escapeHtml(fmtNum(r["Ù…ØµØ±ÙˆÙ"]||0))}</td>
      <td>${escapeHtml(fmtNum(r["Ø§ÙŠØ±Ø§Ø¯"]||0))}</td>
      <td>${escapeHtml(r["addedBy"]||"")}</td>
      <td>${escapeHtml(r["addedTimestamp"] ? r["addedTimestamp"].slice(0,19).replace("T"," ") : "")}</td>
    </tr>
  `).join("");
}

function renderHistory(){
  const wrap = document.getElementById("historyList");
  if(!state.history.length){
    wrap.innerHTML = `<div class="alert alert-info">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯</div>`;
    return;
  }
  wrap.innerHTML = state.history.map(h=>{
    const d = new Date(h.timestamp);
    const dd = isNaN(d) ? "" : d.toISOString().slice(0,10);
    const tt = isNaN(d) ? "" : d.toISOString().slice(11,19);
    return `
      <div class="cardx mb-2">
        <div class="d-flex justify-content-between">
          <div>
            <div class="fw-bold">${escapeHtml(h.action)}</div>
            <div class="muted">${escapeHtml(h.details)}</div>
          </div>
          <div class="smallmuted text-nowrap">${dd}<br>${tt}</div>
        </div>
      </div>
    `;
  }).join("");
}

function renderFiles(){
  const empty = document.getElementById("filesEmpty");
  const panel = document.getElementById("filesPanel");
  if(!state.loadedFiles.length){
    empty.style.display = "block";
    panel.style.display = "none";
    return;
  }
  empty.style.display = "none";
  panel.style.display = "block";

  document.getElementById("filesCount").textContent = state.loadedFiles.length;
  document.getElementById("rowsCount").textContent = state.rows.length;

  const tb = document.getElementById("filesTbody");
  tb.innerHTML = state.loadedFiles.map((f, idx)=>{
    return `
      <tr>
        <td>${escapeHtml(f.name)}</td>
        <td>${Number(f.rows||0).toLocaleString("ar-SA")}</td>
        <td>${escapeHtml((f.date||"").slice(0,16).replace("T"," "))}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger" onclick="deleteFile(${idx})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </td>
      </tr>
    `;
  }).join("");

  renderDuplicatesInfo();
}

function renderDuplicatesInfo(){
  const {dups} = findDuplicates();
  const msg = document.getElementById("dupMsg");
  if(dups.length){
    msg.innerHTML = `âš ï¸ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ <b>${dups.length.toLocaleString("ar-SA")}</b> Ø¹Ù…Ù„ÙŠØ© Ù…ÙƒØ±Ø±Ø© Ù…Ø­ØªÙ…Ù„Ø© (Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®+Ø§Ù„Ø­Ø³Ø§Ø¨+Ù…ØµØ±ÙˆÙ+Ø§ÙŠØ±Ø§Ø¯).`;
  } else {
    msg.textContent = "âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…ÙƒØ±Ø±Ø©";
  }
  document.getElementById("dupsTableWrap").style.display = "none";
}

/* =========================
   Duplicates
========================= */
function dupKey(r){
  return `${fmtDate(r["Ø§Ù„ØªØ§Ø±ÙŠØ®"])}|${r["Ø§Ù„Ø­Ø³Ø§Ø¨"]||""}|${Number(r["Ù…ØµØ±ÙˆÙ"]||0)}|${Number(r["Ø§ÙŠØ±Ø§Ø¯"]||0)}`;
}
function findDuplicates(){
  const map = new Map();
  state.rows.forEach((r, idx)=>{
    const k = dupKey(r);
    if(!map.has(k)) map.set(k, []);
    map.get(k).push({r, idx});
  });
  const dups = [];
  for(const arr of map.values()){
    if(arr.length > 1){
      arr.forEach(x=>dups.push(x));
    }
  }
  return { dups, groups: map };
}

/* =========================
   Navigation
========================= */
function showPage(key){
  document.querySelectorAll(".page").forEach(p=>p.style.display="none");
  document.getElementById("page-"+key).style.display = "block";
  document.querySelectorAll(".navbtn").forEach(b=>b.classList.remove("active"));
  document.querySelector(`.navbtn[data-page="${key}"]`).classList.add("active");

  // refresh page content
  if(key==="dashboard") renderDashboard();
  if(key==="data"){ fillFilters(); renderTable(); }
  if(key==="add") initAddForm();
  if(key==="history") renderHistory();
  if(key==="export") {/* noop */}
  if(key==="files") renderFiles();
}

document.querySelectorAll(".navbtn").forEach(btn=>{
  btn.addEventListener("click", ()=> showPage(btn.dataset.page));
});

/* =========================
   Upload handling
========================= */
document.getElementById("fileInput").addEventListener("change", async (e)=>{
  const files = [...(e.target.files||[])];
  if(!files.length) return;

  const status = document.getElementById("uploadStatus");
  status.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„Ø¯Ù…Ø¬...";

  let totalAdded = 0;

  for(const file of files){
    // prevent duplicate load by name
    const already = state.loadedFiles.some(x=>x.name === file.name);
    if(already){
      status.textContent = `ØªØ¬Ø§Ù‡Ù„Øª ${file.name} (Ù…Ø­Ù…Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹).`;
      continue;
    }
    try{
      const rows = await parseExcelFile(file);
      rows.forEach(r=> r.sourceFile = file.name);

      state.rows = state.rows.concat(rows);
      state.loadedFiles.push({ name:file.name, rows: rows.length, date: new Date().toISOString() });
      totalAdded += rows.length;

      addHistory("ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù", `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${rows.length} Ø¹Ù…Ù„ÙŠØ© Ù…Ù† ${file.name}`);
      saveState();
      status.textContent = `âœ… ${file.name}: ØªÙ… ØªØ­Ù…ÙŠÙ„ ${rows.length} Ø¹Ù…Ù„ÙŠØ©`;
    } catch(err){
      status.textContent = `âŒ ${file.name}: ${err.message || err}`;
    }
  }

  renderCounts();
  renderDashboard();
});

/* =========================
   Data filters events
========================= */
["filterMonth","filterAccount","filterType"].forEach(id=>{
  document.getElementById(id).addEventListener("change", renderTable);
});

/* =========================
   Add form
========================= */
function initAddForm(){
  // set default date today
  const today = new Date().toISOString().slice(0,10);
  document.getElementById("fDate").value = today;

  const sel = document.getElementById("fMonth");
  sel.innerHTML = `<option value="">Ø§Ø®ØªØ±</option>` + AR_MONTHS.map(m=>`<option>${m}</option>`).join("");
  // default month based on today
  sel.value = deriveMonthFromDate(today);

  document.getElementById("addMsg").innerHTML = "";
}

document.getElementById("addForm").addEventListener("submit", (e)=>{
  e.preventDefault();
  const addedBy = safeText(document.getElementById("fAddedBy").value);
  const dateVal = document.getElementById("fDate").value;
  const month = safeText(document.getElementById("fMonth").value);
  const account = safeText(document.getElementById("fAccount").value);
  const payType = safeText(document.getElementById("fPayType").value);
  const amount = Number(document.getElementById("fAmount").value || 0);
  const desc = safeText(document.getElementById("fDesc").value);
  const ref = safeText(document.getElementById("fRef").value);
  const txType = document.querySelector('input[name="fTxType"]:checked').value;

  const msg = document.getElementById("addMsg");
  msg.innerHTML = "";

  if(!addedBy || !dateVal || !month || !account || !payType || !desc || !(amount>0)){
    msg.innerHTML = `<div class="alert alert-danger">âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙˆØ¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±</div>`;
    return;
  }

  const iso = new Date(dateVal).toISOString();
  const row = {
    "Ø§Ù„ØªØ§Ø±ÙŠØ®": iso,
    "Ø§Ù„Ø´Ù‡Ø±": month,
    "Ø§Ù„Ø­Ø³Ø§Ø¨": account,
    "Ø§Ù„Ù†ÙˆØ¹": payType,
    "ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©": desc,
    "Ø§Ù„Ù…Ø±Ø¬Ø¹": ref,
    "Ù…ØµØ±ÙˆÙ": txType==="exp" ? amount : 0,
    "Ø§ÙŠØ±Ø§Ø¯": txType==="rev" ? amount : 0,
    "addedBy": addedBy,
    "addedTimestamp": new Date().toISOString(),
    "addedManually": true,
    "sourceFile": ""
  };

  state.rows.push(row);
  addHistory("Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©", `${txType==="rev" ? "Ø¥ÙŠØ±Ø§Ø¯" : "Ù…ØµØ±ÙˆÙ"} - ${account} - ${fmtNum(amount)} Ø±ÙŠØ§Ù„ - Ø¨ÙˆØ§Ø³Ø·Ø© ${addedBy}`);
  saveState();

  msg.innerHTML = `<div class="alert alert-success">âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!</div>`;
  e.target.reset();
  initAddForm();
  renderCounts();
  renderDashboard();
});

/* =========================
   Export & Data management
========================= */
function downloadBlob(filename, mime, data){
  const blob = new Blob([data], {type:mime});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

document.getElementById("btnExportJson").addEventListener("click", ()=>{
  const data = JSON.stringify(state.rows, null, 2);
  const name = `Ø§Ù„Ø§ÙŠØ±Ø§Ø¯Ø§Øª_ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª_${new Date().toISOString().slice(0,10).replaceAll("-","")}.json`;
  downloadBlob(name, "application/json", data);
});

document.getElementById("btnExportExcel").addEventListener("click", ()=>{
  const exportRows = state.rows.map(r=>({
    "Ø§Ù„ØªØ§Ø±ÙŠØ®": fmtDate(r["Ø§Ù„ØªØ§Ø±ÙŠØ®"]),
    "Ø§Ù„Ø´Ù‡Ø±": r["Ø§Ù„Ø´Ù‡Ø±"]||"",
    "Ø§Ù„Ø­Ø³Ø§Ø¨": r["Ø§Ù„Ø­Ø³Ø§Ø¨"]||"",
    "Ø§Ù„Ù†ÙˆØ¹": r["Ø§Ù„Ù†ÙˆØ¹"]||"",
    "Ø§Ù„ÙˆØµÙ": r["ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"]||"",
    "Ø§Ù„Ù…Ø±Ø¬Ø¹": r["Ø§Ù„Ù…Ø±Ø¬Ø¹"]||"",
    "Ø§Ù„Ù…ØµØ±ÙˆÙ": Number(r["Ù…ØµØ±ÙˆÙ"]||0),
    "Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯": Number(r["Ø§ÙŠØ±Ø§Ø¯"]||0),
    "Ø§Ù„Ù…Ø¶ÙŠÙ": r["addedBy"]||"",
    "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©": r["addedTimestamp"] ? r["addedTimestamp"].slice(0,19).replace("T"," ") : "",
    "Ø§Ù„Ù…ØµØ¯Ø±": r.sourceFile || (r.addedManually ? "ÙŠØ¯ÙˆÙŠ" : "")
  }));
  const ws = XLSX.utils.json_to_sheet(exportRows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Ø¨ÙŠØ§Ù†Ø§Øª");
  const out = XLSX.write(wb, {bookType:"xlsx", type:"array"});
  const name = `Ø§Ù„Ø§ÙŠØ±Ø§Ø¯Ø§Øª_ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª_${new Date().toISOString().slice(0,10).replaceAll("-","")}.xlsx`;
  downloadBlob(name, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", out);
});

document.getElementById("btnDeleteManual").addEventListener("click", ()=>{
  const before = state.rows.length;
  state.rows = state.rows.filter(r => r.addedManually !== true);
  const removed = before - state.rows.length;
  addHistory("Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¶Ø§ÙØ©", `ØªÙ… Ø­Ø°Ù ${removed} Ø¹Ù…Ù„ÙŠØ© Ù…Ø¶Ø§ÙØ© ÙŠØ¯ÙˆÙŠØ§Ù‹`);
  saveState();
  document.getElementById("exportMsg").innerHTML = `<div class="alert alert-success">âœ… ØªÙ… Ø­Ø°Ù ${removed} Ø¹Ù…Ù„ÙŠØ© Ù…Ø¶Ø§ÙØ©</div>`;
  renderCounts(); renderDashboard();
});

document.getElementById("btnDeleteAll").addEventListener("click", ()=>{
  const ok = confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ø³Ø¬Ù„ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ");
  if(!ok) return;
  const count = state.rows.length;
  state = { rows:[], loadedFiles:[], history:[] };
  saveState();
  document.getElementById("exportMsg").innerHTML = `<div class="alert alert-success">âœ… ØªÙ… Ø­Ø°Ù ${count} Ø¹Ù…Ù„ÙŠØ©</div>`;
  renderCounts(); renderDashboard(); renderFiles(); renderHistory();
});

/* =========================
   Files page actions
========================= */
window.deleteFile = function(idx){
  const f = state.loadedFiles[idx];
  if(!f) return;
  const ok = confirm(`Ø­Ø°Ù ${f.name} Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ¥Ø²Ø§Ù„Ø© Ø¹Ù…Ù„ÙŠØ§ØªÙ‡ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ`);
  if(!ok) return;

  const before = state.rows.length;
  // remove rows from this source file (and not manual)
  state.rows = state.rows.filter(r => r.sourceFile !== f.name);
  state.loadedFiles.splice(idx, 1);
  const removed = before - state.rows.length;

  addHistory("Ø­Ø°Ù Ù…Ù„Ù", `ØªÙ… Ø­Ø°Ù ${f.name} ÙˆØ¥Ø²Ø§Ù„Ø© ${removed} Ø¹Ù…Ù„ÙŠØ© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡`);
  saveState();

  renderCounts(); renderDashboard(); renderFiles();
  document.getElementById("filesMsg").innerHTML = `<div class="alert alert-success">âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù ÙˆØ¥Ø²Ø§Ù„Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙ‡</div>`;
};

document.getElementById("btnResetFiles").addEventListener("click", ()=>{
  const ok = confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø³Ø¬Ù„ ÙŠØ¨Ù‚Ù‰). Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ");
  if(!ok) return;
  state.rows = [];
  state.loadedFiles = [];
  addHistory("Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„", "ØªÙ… Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  saveState();
  renderCounts(); renderDashboard(); renderFiles();
  document.getElementById("filesMsg").innerHTML = `<div class="alert alert-success">âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>`;
});

document.getElementById("btnClearHistory").addEventListener("click", ()=>{
  const ok = confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ");
  if(!ok) return;
  state.history = [];
  saveState();
  renderHistory();
  document.getElementById("filesMsg").innerHTML = `<div class="alert alert-success">âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</div>`;
});

document.getElementById("btnQuickStats").addEventListener("click", ()=>{
  const months = uniq(state.rows.map(r=>r["Ø§Ù„Ø´Ù‡Ø±"]).filter(Boolean)).length;
  const accounts = uniq(state.rows.map(r=>r["Ø§Ù„Ø­Ø³Ø§Ø¨"]).filter(Boolean)).length;
  document.getElementById("filesMsg").innerHTML = `
    <div class="alert alert-info">
      ğŸ“Œ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±: <b>${months.toLocaleString("ar-SA")}</b> â€” Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª: <b>${accounts.toLocaleString("ar-SA")}</b>
    </div>
  `;
});

document.getElementById("btnShowDups").addEventListener("click", ()=>{
  const {dups} = findDuplicates();
  const wrap = document.getElementById("dupsTableWrap");
  const tb = document.getElementById("dupsTbody");
  if(!dups.length){
    wrap.style.display = "none";
    return;
  }
  tb.innerHTML = dups.map(x=>{
    const r = x.r;
    return `
      <tr>
        <td>${escapeHtml(fmtDate(r["Ø§Ù„ØªØ§Ø±ÙŠØ®"]))}</td>
        <td>${escapeHtml(r["Ø§Ù„Ø´Ù‡Ø±"]||"")}</td>
        <td>${escapeHtml(r["Ø§Ù„Ø­Ø³Ø§Ø¨"]||"")}</td>
        <td>${escapeHtml(r["ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"]||"")}</td>
        <td>${escapeHtml(fmtNum(r["Ù…ØµØ±ÙˆÙ"]||0))}</td>
        <td>${escapeHtml(fmtNum(r["Ø§ÙŠØ±Ø§Ø¯"]||0))}</td>
        <td>${escapeHtml(r.sourceFile || (r.addedManually ? "ÙŠØ¯ÙˆÙŠ" : ""))}</td>
      </tr>
    `;
  }).join("");
  wrap.style.display = "block";
});

document.getElementById("btnRemoveDups").addEventListener("click", ()=>{
  const {groups} = findDuplicates();
  const keep = new Set();
  // keep first occurrence for each key
  for(const arr of groups.values()){
    if(arr.length === 0) continue;
    keep.add(arr[0].idx);
  }
  const before = state.rows.length;
  state.rows = state.rows.filter((r, idx)=> keep.has(idx));
  const removed = before - state.rows.length;

  if(removed>0){
    addHistory("Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª", `ØªÙ… Ø­Ø°Ù ${removed} Ø¹Ù…Ù„ÙŠØ© Ù…ÙƒØ±Ø±Ø©`);
    saveState();
  }
  renderCounts(); renderDashboard(); renderFiles();
  document.getElementById("filesMsg").innerHTML = removed>0
    ? `<div class="alert alert-success">âœ… ØªÙ… Ø­Ø°Ù ${removed} Ø¹Ù…Ù„ÙŠØ© Ù…ÙƒØ±Ø±Ø©</div>`
    : `<div class="alert alert-info">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙƒØ±Ø§Ø±Ø§Øª Ù„Ù„Ø­Ø°Ù</div>`;
});

/* =========================
   Security: simple escaping
========================= */
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   Boot
========================= */
loadState();
renderCounts();
renderDashboard();
initAddForm();
showPage("dashboard");
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
